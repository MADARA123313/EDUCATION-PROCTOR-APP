<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è ADVANCED EDUCATION PROCTOR DASHBOARD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .status-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            color: white;
            transition: transform 0.3s ease;
        }

        .status-item:hover {
            transform: translateY(-5px);
        }

        .status-item h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .status-item p {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .panel {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .panel-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .panel-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .incidents-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .incident-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .incident-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background: #3498db;
        }

        .incident-item.severity-1::before { background: #27ae60; }
        .incident-item.severity-2::before { background: #f39c12; }
        .incident-item.severity-3::before { background: #e74c3c; }
        .incident-item.severity-4::before { background: #8e44ad; }

        .incident-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .incident-type {
            font-weight: bold;
            color: #2c3e50;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .incident-time {
            color: #7f8c8d;
            font-size: 0.8em;
        }

        .incident-description {
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .incident-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
        }

        .ai-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .ai-panel h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .ai-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .ai-metric {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .ai-metric h4 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .ai-metric p {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .network-panel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .network-panel h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .network-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .network-stat {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .network-stat h4 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .network-stat p {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .behavioral-panel {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .behavioral-panel h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .behavioral-patterns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .behavioral-pattern {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
        }

        .behavioral-pattern h4 {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .behavioral-pattern .risk-score {
            background: rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
        }

        .export-panel {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .export-panel h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .export-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .export-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .qr-panel {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .qr-panel h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .qr-code {
            max-width: 200px;
            margin: 0 auto;
        }

        .settings-panel {
            background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .settings-panel h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: bold;
            color: #2c3e50;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ccc;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle.active {
            background: #27ae60;
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle.active::after {
            transform: translateX(25px);
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-controls select,
        .filter-controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .real-time-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #27ae60;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 10px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .threat-level {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8em;
        }

        .threat-level.low { background: #27ae60; color: white; }
        .threat-level.medium { background: #f39c12; color: white; }
        .threat-level.high { background: #e74c3c; color: white; }
        .threat-level.critical { background: #8e44ad; color: white; }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .info {
            background: #3498db;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .warning {
            background: #f39c12;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .filter-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ°Ô∏è ADVANCED EDUCATION PROCTOR</h1>
        <div class="subtitle">AI-Powered Security Monitoring System v2.0</div>
        <div class="real-time-indicator"></div>
        <span>Real-time Monitoring Active</span>
    </div>

    <div class="status-bar" id="status-bar">
        <div class="status-item">
            <h3 id="total-incidents">0</h3>
            <p>Total Incidents</p>
        </div>
        <div class="status-item">
            <h3 id="active-devices">0</h3>
            <p>Active Devices</p>
        </div>
        <div class="status-item">
            <h3 id="threat-level">LOW</h3>
            <p>Threat Level</p>
        </div>
        <div class="status-item">
            <h3 id="ai-confidence">0%</h3>
            <p>AI Confidence</p>
        </div>
        <div class="status-item">
            <h3 id="system-health">100%</h3>
            <p>System Health</p>
        </div>
        <div class="status-item">
            <h3 id="network-status">ONLINE</h3>
            <p>Network Status</p>
        </div>
    </div>

    <div class="main-content">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">üö® Real-time Incident Feed</div>
                <div class="panel-controls">
                    <button class="btn btn-primary" onclick="refreshIncidents()">Refresh</button>
                    <button class="btn btn-success" onclick="exportIncidents()">Export</button>
                    <button class="btn btn-warning" onclick="clearIncidents()">Clear</button>
                </div>
            </div>
            <div class="filter-controls">
                <select id="device-filter">
                    <option value="all">All Devices</option>
                </select>
                <select id="severity-filter">
                    <option value="all">All Severities</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
                <select id="time-filter">
                    <option value="all">All Time</option>
                    <option value="1h">Last Hour</option>
                    <option value="6h">Last 6 Hours</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                </select>
                <input type="text" id="search-box" placeholder="Search incidents...">
            </div>
            <div class="incidents-list" id="incidents-list">
                <div class="loading">Loading incidents...</div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">üìä Advanced Analytics</div>
                <div class="panel-controls">
                    <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                    <button class="btn btn-success" onclick="runAIAnalysis()">AI Analysis</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="incidents-chart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="threat-timeline"></canvas>
            </div>
        </div>
    </div>

    <div class="ai-panel">
        <h3>ü§ñ AI-Powered Threat Detection</h3>
        <div class="ai-metrics">
            <div class="ai-metric">
                <h4 id="ai-threats">0</h4>
                <p>Threats Detected</p>
            </div>
            <div class="ai-metric">
                <h4 id="ai-confidence-score">0%</h4>
                <p>AI Confidence</p>
            </div>
            <div class="ai-metric">
                <h4 id="behavioral-risks">0</h4>
                <p>Behavioral Risks</p>
            </div>
            <div class="ai-metric">
                <h4 id="network-anomalies">0</h4>
                <p>Network Anomalies</p>
            </div>
        </div>
    </div>

    <div class="network-panel">
        <h3>üåê Network Security Analysis</h3>
        <div class="network-stats">
            <div class="network-stat">
                <h4 id="active-connections">0</h4>
                <p>Active Connections</p>
            </div>
            <div class="network-stat">
                <h4 id="bandwidth-usage">0 MB</h4>
                <p>Bandwidth Usage</p>
            </div>
            <div class="network-stat">
                <h4 id="suspicious-ips">0</h4>
                <p>Suspicious IPs</p>
            </div>
            <div class="network-stat">
                <h4 id="blocked-connections">0</h4>
                <p>Blocked Connections</p>
            </div>
        </div>
    </div>

    <div class="behavioral-panel">
        <h3>üë§ Behavioral Analysis</h3>
        <div class="behavioral-patterns" id="behavioral-patterns">
            <div class="behavioral-pattern">
                <h4>Mouse Movement</h4>
                <div class="risk-score">Risk: 15%</div>
            </div>
            <div class="behavioral-pattern">
                <h4>Keyboard Patterns</h4>
                <div class="risk-score">Risk: 8%</div>
            </div>
            <div class="behavioral-pattern">
                <h4>Application Usage</h4>
                <div class="risk-score">Risk: 22%</div>
            </div>
        </div>
    </div>

    <div class="export-panel">
        <h3>üì§ Advanced Export & Reporting</h3>
        <div class="export-buttons">
            <div class="export-btn" onclick="exportPDF()">
                <h4>üìÑ PDF Report</h4>
                <p>Generate detailed PDF report</p>
            </div>
            <div class="export-btn" onclick="exportExcel()">
                <h4>üìä Excel Report</h4>
                <p>Export data to Excel</p>
            </div>
            <div class="export-btn" onclick="exportJSON()">
                <h4>üîß JSON Data</h4>
                <p>Export raw data</p>
            </div>
            <div class="export-btn" onclick="exportCSV()">
                <h4>üìà CSV Data</h4>
                <p>Export incidents to CSV</p>
            </div>
        </div>
    </div>

    <div class="qr-panel">
        <h3>üì± Quick Access QR Code</h3>
        <div class="qr-code" id="qr-code">
            <div class="loading">Generating QR code...</div>
        </div>
        <p>Scan to access dashboard on mobile devices</p>
    </div>

    <div class="settings-panel">
        <h3>‚öôÔ∏è Advanced Settings</h3>
        <div class="setting-item">
            <span class="setting-label">AI Monitoring</span>
            <div class="setting-control">
                <div class="toggle active" onclick="toggleSetting(this, 'ai_monitoring')"></div>
                <span>Enabled</span>
            </div>
        </div>
        <div class="setting-item">
            <span class="setting-label">Screenshot Analysis</span>
            <div class="setting-control">
                <div class="toggle active" onclick="toggleSetting(this, 'screenshot_analysis')"></div>
                <span>Enabled</span>
            </div>
        </div>
        <div class="setting-item">
            <span class="setting-label">Behavioral Analysis</span>
            <div class="setting-control">
                <div class="toggle active" onclick="toggleSetting(this, 'behavioral_analysis')"></div>
                <span>Enabled</span>
            </div>
        </div>
        <div class="setting-item">
            <span class="setting-label">Network Deep Scan</span>
            <div class="setting-control">
                <div class="toggle active" onclick="toggleSetting(this, 'network_scan')"></div>
                <span>Enabled</span>
            </div>
        </div>
        <div class="setting-item">
            <span class="setting-label">Email Alerts</span>
            <div class="setting-control">
                <div class="toggle" onclick="toggleSetting(this, 'email_alerts')"></div>
                <span>Disabled</span>
            </div>
        </div>
        <div class="setting-item">
            <span class="setting-label">Real-time Analysis</span>
            <div class="setting-control">
                <div class="toggle active" onclick="toggleSetting(this, 'real_time_analysis')"></div>
                <span>Enabled</span>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let incidents = [];
        let devices = [];
        let charts = {};
        let settings = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            loadDashboard();
            setupCharts();
            setupEventListeners();
            loadQRCode();
        });

        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to dashboard');
                showNotification('Connected to dashboard', 'success');
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from dashboard');
                showNotification('Disconnected from dashboard', 'error');
            });
            
            socket.on('new_incident', function(incident) {
                incidents.unshift(incident);
                renderIncidents();
                updateStats();
                showNotification(`New incident: ${incident.event_type}`, 'info');
            });
            
            socket.on('device_updated', function(device) {
                updateDeviceStatus(device);
            });
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load incidents
                const incidentsResponse = await fetch('/api/incidents');
                incidents = await incidentsResponse.json();
                renderIncidents();
                
                // Load devices
                const devicesResponse = await fetch('/api/devices');
                devices = await devicesResponse.json();
                populateDeviceFilter();
                
                // Load stats
                const statsResponse = await fetch('/api/stats');
                const stats = await statsResponse.json();
                updateStats(stats);
                
                // Load settings
                const settingsResponse = await fetch('/api/advanced/settings');
                settings = await settingsResponse.json();
                updateSettings();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showNotification('Error loading dashboard data', 'error');
            }
        }

        // Render incidents
        function renderIncidents() {
            const container = document.getElementById('incidents-list');
            if (!incidents.length) {
                container.innerHTML = '<div class="loading">No incidents found</div>';
                return;
            }
            
            const filteredIncidents = filterIncidents();
            container.innerHTML = filteredIncidents.map(incident => `
                <div class="incident-item severity-${incident.severity}">
                    <div class="incident-header">
                        <span class="incident-type">${incident.event_type.replace('_', ' ')}</span>
                        <span class="incident-time">${new Date(incident.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="incident-description">${incident.description}</div>
                    <div class="incident-actions">
                        <button class="btn btn-success" onclick="acknowledgeIncident(${incident.id})">Acknowledge</button>
                        <button class="btn btn-primary" onclick="viewDetails(${incident.id})">View Details</button>
                        <button class="btn btn-warning" onclick="exportIncident(${incident.id})">Export</button>
                    </div>
                </div>
            `).join('');
        }

        // Filter incidents
        function filterIncidents() {
            let filtered = incidents;
            
            // Device filter
            const deviceFilter = document.getElementById('device-filter').value;
            if (deviceFilter !== 'all') {
                filtered = filtered.filter(inc => inc.device_id === deviceFilter);
            }
            
            // Severity filter
            const severityFilter = document.getElementById('severity-filter').value;
            if (severityFilter !== 'all') {
                const severityMap = {'low': 1, 'medium': 2, 'high': 3, 'critical': 4};
                const minSeverity = severityMap[severityFilter];
                filtered = filtered.filter(inc => inc.severity >= minSeverity);
            }
            
            // Time filter
            const timeFilter = document.getElementById('time-filter').value;
            if (timeFilter !== 'all') {
                const timeMap = {'1h': 1, '6h': 6, '24h': 24, '7d': 168};
                const hours = timeMap[timeFilter];
                const cutoff = new Date(Date.now() - hours * 60 * 60 * 1000);
                filtered = filtered.filter(inc => new Date(inc.timestamp) > cutoff);
            }
            
            // Search filter
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(inc => 
                    inc.description.toLowerCase().includes(searchTerm) ||
                    inc.event_type.toLowerCase().includes(searchTerm)
                );
            }
            
            return filtered;
        }

        // Update stats
        function updateStats(stats = null) {
            if (stats) {
                document.getElementById('total-incidents').textContent = stats.total_incidents;
                document.getElementById('active-devices').textContent = stats.active_devices;
                document.getElementById('threat-level').textContent = stats.threat_level;
                document.getElementById('ai-confidence').textContent = Math.round(stats.ai_confidence * 100) + '%';
                document.getElementById('system-health').textContent = stats.system_health.score + '%';
                document.getElementById('network-status').textContent = stats.network_status.status;
            }
        }

        // Setup charts
        function setupCharts() {
            // Incidents chart
            const incidentsCtx = document.getElementById('incidents-chart').getContext('2d');
            charts.incidents = new Chart(incidentsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Incidents',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Threat timeline
            const threatCtx = document.getElementById('threat-timeline').getContext('2d');
            charts.threat = new Chart(threatCtx, {
                type: 'bar',
                data: {
                    labels: ['Low', 'Medium', 'High', 'Critical'],
                    datasets: [{
                        label: 'Threat Levels',
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#27ae60', '#f39c12', '#e74c3c', '#8e44ad']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Filter controls
            document.getElementById('device-filter').addEventListener('change', renderIncidents);
            document.getElementById('severity-filter').addEventListener('change', renderIncidents);
            document.getElementById('time-filter').addEventListener('change', renderIncidents);
            document.getElementById('search-box').addEventListener('input', renderIncidents);
        }

        // Populate device filter
        function populateDeviceFilter() {
            const deviceFilter = document.getElementById('device-filter');
            deviceFilter.innerHTML = '<option value="all">All Devices</option>';
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = device.id;
                deviceFilter.appendChild(option);
            });
        }

        // Load QR code
        async function loadQRCode() {
            try {
                const response = await fetch('/api/qr/generate');
                const data = await response.json();
                if (data.qr_code) {
                    document.getElementById('qr-code').innerHTML = 
                        `<img src="data:image/png;base64,${data.qr_code}" alt="QR Code" style="max-width: 200px;">`;
                }
            } catch (error) {
                console.error('Error loading QR code:', error);
            }
        }

        // Toggle setting
        function toggleSetting(element, setting) {
            element.classList.toggle('active');
            const isActive = element.classList.contains('active');
            const span = element.nextElementSibling;
            span.textContent = isActive ? 'Enabled' : 'Disabled';
            
            // Update setting
            settings[setting] = isActive;
            updateSetting(setting, isActive);
        }

        // Update setting
        async function updateSetting(setting, value) {
            try {
                await fetch('/api/advanced/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({[setting]: value})
                });
            } catch (error) {
                console.error('Error updating setting:', error);
            }
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px;
                border-radius: 10px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            if (type === 'success') notification.style.background = '#27ae60';
            else if (type === 'error') notification.style.background = '#e74c3c';
            else if (type === 'info') notification.style.background = '#3498db';
            else if (type === 'warning') notification.style.background = '#f39c12';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Action functions
        function acknowledgeIncident(id) {
            // Implementation for acknowledging incident
            showNotification('Incident acknowledged', 'success');
        }

        function viewDetails(id) {
            // Implementation for viewing incident details
            showNotification('Opening incident details', 'info');
        }

        function exportIncident(id) {
            // Implementation for exporting incident
            showNotification('Exporting incident', 'info');
        }

        function refreshIncidents() {
            loadDashboard();
            showNotification('Incidents refreshed', 'success');
        }

        function exportIncidents() {
            // Implementation for exporting incidents
            showNotification('Exporting incidents', 'info');
        }

        function clearIncidents() {
            if (confirm('Are you sure you want to clear all incidents?')) {
                // Implementation for clearing incidents
                showNotification('Incidents cleared', 'success');
            }
        }

        function generateReport() {
            // Implementation for generating report
            showNotification('Generating report', 'info');
        }

        function runAIAnalysis() {
            // Implementation for AI analysis
            showNotification('Running AI analysis', 'info');
        }

        function exportPDF() {
            // Implementation for PDF export
            showNotification('Exporting PDF report', 'info');
        }

        function exportExcel() {
            // Implementation for Excel export
            showNotification('Exporting Excel report', 'info');
        }

        function exportJSON() {
            // Implementation for JSON export
            showNotification('Exporting JSON data', 'info');
        }

        function exportCSV() {
            // Implementation for CSV export
            showNotification('Exporting CSV data', 'info');
        }

        // Update charts periodically
        setInterval(() => {
            updateCharts();
        }, 5000);

        function updateCharts() {
            // Update incidents chart
            const now = new Date();
            const labels = [];
            const data = [];
            
            for (let i = 23; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 60 * 60 * 1000);
                labels.push(time.getHours() + ':00');
                const count = incidents.filter(inc => {
                    const incTime = new Date(inc.timestamp);
                    return incTime >= time && incTime < new Date(time.getTime() + 60 * 60 * 1000);
                }).length;
                data.push(count);
            }
            
            charts.incidents.data.labels = labels;
            charts.incidents.data.datasets[0].data = data;
            charts.incidents.update();
            
            // Update threat chart
            const threatCounts = [0, 0, 0, 0];
            incidents.forEach(inc => {
                if (inc.severity >= 1 && inc.severity <= 4) {
                    threatCounts[inc.severity - 1]++;
                }
            });
            
            charts.threat.data.datasets[0].data = threatCounts;
            charts.threat.update();
        }
    </script>
</body>
</html>
